---
title: "Error Bar Plot"
author: "Defeng Bai Agricultural Genomics Institute at Shenzhen, Chinese Academy of Agricultural Sciences"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo=T, comment=NA, message=F, warning=F,
	fig.align="center", fig.width=5, fig.height=3, dpi=300)
```


### 误差棒点图
Error Bar Plot

误差棒是用来反映数据不确定性的，以被测量值的算数平均值为重点。一般使用在散点图中，以线段的方式显示出来。误差棒长度越长代表误差越大，反之则误差越小。
Error bars are used to reflect data uncertainty, with a focus on the arithmetic mean of the measured values. Generally used in scatter plots, displayed in the form of line segments. The longer the length of the error bar, the greater the error, and vice versa, the smaller the error.


### 误差棒点图案例
Example of error bar plot

案例一

这是北京大学Wang Wei团队2023年发表于Global Change Biology（Zhang et al., 2023）上的一篇论文，题目为：Soil fertility shifts the relative importance of saprotrophic and mycorrhizal fungi for maintaining ecosystem stability

This is a paper published by Wang Wei's team from Peking University in Global Change Biology (Zhang et al., 2023), titled: Soil fertility shifts the relative importance of astrology and mycorrhizal fungi for maintaining ecosystem stability


![](e1.ErrorBarPlot.01.jpg)

Figure 3 Controlling factors of ecosystem stability in the (a, b) regional and (c, d) global surveys. Multiple regression analyses reveal the relative importance of biotic and abiotic predictors of ecosystem stability. The standardized regression coefficients are shown for each variable with their 95% confidence intervals. C:N, ratio of soil carbon to nitrogen; MAT, mean annual temperature; STN, soil total nitrogen; STP, soil total phosphorus. Significance levels: *p < .05, **p < .01, ***p < .001. 

图3（a，b）区域调查和（c，d）全球调查中生态系统稳定性的控制因素。多元回归分析揭示了生态系统稳定性的生物和非生物预测因子的相对重要性。显示了每个变量的标准化回归系数及其95%置信区间。C： N，土壤碳氮比；MAT，年平均气温；STN，土壤总氮；STP，土壤总磷。显著性水平：*p<.05，**p<.01，***p<.001。


**结果**：
These positive relationships remained after accounting for plant diversity, climate, soil properties, and geographic distance (Figure 3a,b). And their effects on ecosystem stability were maintained after considering environmental factors (Figure 3c,d). Significant effects of the diversity within fungal functional groups on ecosystem stability were maintained after accounting for plant and environmental variables, indicating that the stabilizing role of microbial diversity was non-substitutable
in real-world ecosystems (Figure 3).

考虑到植物多样性、气候、土壤特性和地理距离后，这些正相关关系仍然存在（图3a、b）。在考虑环境因素后，它们对生态系统稳定性的影响得以维持（图3c，d）。在考虑了植物和环境变量后，真菌官能团内的多样性对生态系统稳定性的显著影响得以维持，这表明微生物多样性的稳定作用在现实世界的生态系统中是不可替代的（图3）。



案例二

这是来自于加拿大多伦多大学儿童医院的Stephen W. Scherer团队2024年发表于Nature Genetics上的一篇论文。题目为：Comprehensive whole-genome sequence analyses provide insights into the genomic architecture of cerebral palsy.

This is a paper published in Nature Genetics by Stephen W. Scherer's team from the University of Toronto Children's Hospital in Canada in 2024. The title is: Comprehensive whole genome sequence analysis provides insights into the genomic architecture of cerebra.

![](e1.ErrorBarPlot.02.jpg)

Fig. 2 | Gene-set analysis of de novo SNVs/indels and large TRs. Three panels represent gene-set-level analysis results of de novo LOF variants (burden analysis), de novo missense variants (burden analysis) and large TRs (transmission test). The colors indicate the different cohorts and the points indicate the effect size as estimated with Fisher’s exact test as the OR with error bars indicating 95% CIs (n = 203, 178 and 314 for Inova, CHILD and CP, respectively). Significant results are marked with asterisks, that is, those with Benjamini–Hochberg FDR < 10%. AD, autosomal dominant.

图2|新SNVs/indels和大TR的基因集分析。三个面板代表了从头LOF变体（负载分析）、从头错义变体（负担分析）和大TR（传播测试）的基因集水平分析结果。颜色表示不同的队列，点表示用Fisher精确检验作为OR估计的效应大小，误差条表示95%的CI（Inova、CHILD和CP分别为n=203178和314）。显著结果用星号标记，即Benjamini–Hochberg FDR<10%的结果。AD，常染色体显性遗传。

**结果**：
In gene sets associated with CP and NDDs, an overtransmission of large TRs detected by ExpansionHunter Denovo in genes associated with axon guidance and postsynaptic density was observed in the CP cohort (Fig. 2 and Supplementary Table 4).

在与CP和NDD相关的基因集中，在CP队列中观察到ExpansionHunter Denovo在与轴突引导和突触后密度相关的基因中检测到的大TR的过度传递（图2和补充表4）。



### 误差棒点图R语言实战
Error bar chart R language practical application
参考：https://mp.weixin.qq.com/s/60gm99KP8uKoRzna4Nhmwg

```{r Eror bar plot, include=TRUE}
# 加载包
# Load packages
library(ggplot2)

# 加载数据
# Load data
df <- read.csv("test/test_otu.csv", row.names = 1)

# 构建数据框
# Construct dataframe
plot_data <- df[101:112, c(7, 12)]
colnames(plot_data) <- c("Microbes", "error_bar")
plot_data <- as.data.frame(scale(plot_data))

# 错误条数据 (这里使用数据/5作为错误条，实际上应自行计算)
# Error bar data (here use data/5 as error bar, in reality should calculate yourself)
plot_data$error_bar <- plot_data$error_bar / 5

# 选择数据作为 Y 轴
# Select data as Y axis
Factor <- as.data.frame(c(1:12))
plot_data <- cbind(plot_data, Factor)

# 设置组和颜色
# Set group and color
Group <- as.data.frame(c(rep("Group1", 3), rep("Group2", 3), rep("Group3", 3), rep("Group4", 3)))
plot_data <- cbind(plot_data, Group)
colnames(plot_data) <- c("Microbes", "Error_bar", "Factor", "Group")
plot_data$Factor <- as.factor(plot_data$Factor)

# 绘图
# Plot
p1 <- ggplot(plot_data, aes(Microbes, Factor)) +
  geom_point(size = 3, aes(color = Group)) +
  geom_errorbar(aes(xmin = Microbes - Error_bar, xmax = Microbes + Error_bar, color = Group), width = 0.25, cex = 0.7) +
  labs(y = "Index", x = "Effects(%)") +
  geom_vline(aes(xintercept = 0), size = 0.6, linetype = "dashed", colour = "gray2") +
  geom_hline(aes(yintercept = 3.5), size = 0.4, linetype = "dashed", colour = "gray52") +
  geom_hline(aes(yintercept = 6.5), size = 0.4, linetype = "dashed", colour = "gray52") +
  geom_hline(aes(yintercept = 9.5), size = 0.4, linetype = "dashed", colour = "gray52") +
  scale_x_continuous(expand = c(0, 0), limit = c(-2, 2)) +
  scale_color_manual(values = c("#3E516F", "#71959F", "#3FBDA7", "#F1606C")) + # 颜色设置
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(axis.text = element_text(colour = 'black', size = 10))

# 保存图像
# Save plot
ggsave(filename = "Error_bar_plot01.pdf", plot = p1, width = 7, height = 5, useDingbats = FALSE, limitsize = FALSE)

# 显示图像
# Display plot
p1

```


多组误差棒图
参考：https://mp.weixin.qq.com/s/Y8VJ7aTM4PQxOogjSa9QdA

```{r Eror bar plot2, include=TRUE}
# 加载数据
# Load data
df <- read.csv("41588_2024_1686_MOESM7_ESM.csv")

# 基础绘图
# Basic plot
p <- ggplot(data = df, aes(x = OR, y = geneset, fill = set)) +
  geom_errorbarh(aes(xmin = lower, xmax = upper, color = set), height = 0, show.legend = FALSE, position = position_dodge(0.9)) +
  geom_point(position = position_dodge(0.9), aes(color = set), size = 3, show.legend = TRUE)

# 美化图形
# Enhance plot appearance
p2 <- ggplot(data = df, aes(x = OR, y = geneset, fill = set, color = set)) +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0, show.legend = TRUE, position = position_dodge(0.9)) +
  geom_point(position = position_dodge(0.9), size = 3) +
  geom_vline(xintercept = 0.5, linetype = "dashed", color = "gray", size = 0.7) +
  scale_fill_manual(values = c("#DC0000FF", "#3C5488FF", "#00A087FF", "gray")) +
  scale_color_manual(values = c("#DC0000FF", "#3C5488FF", "#00A087FF", "gray")) +
  theme(panel.grid = element_blank(), 
        panel.background = element_blank(), 
        panel.border = element_rect(color = "gray", fill = NA, size = 0.7),
        axis.text.x = element_text(size = 12, color = "black", angle = 0, margin = margin(t = 2)), # 设置X轴刻度文本与刻度线距离
        axis.text.y = element_text(size = 12, colour = "black"),
        axis.title.y = element_text(size = 14),
        axis.ticks.length = unit(0.1, "cm")) +
  labs(x = "", y = "") +
  guides(color = guide_legend(title = NULL), fill = guide_legend(title = NULL))

# 分面及分面标签
# Facet and facet labels
vline_data <- data.frame(
  group = c("LOF", "Missense", "Tandem repeat"),  # 替换为你的分面组
  xintercept = c(1, 1, 1)  # 对应的垂直线位置
)

# 完整图形，包括分面和标签
# Complete plot with facets and labels
p3 <- ggplot(data = df, aes(x = OR, y = geneset, fill = set, color = set)) +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0, show.legend = TRUE, position = position_dodge(0.9)) +
  geom_point(position = position_dodge(0.9), size = 3) +
  geom_vline(data = vline_data, aes(xintercept = xintercept), linetype = "dashed", color = "black", size = 0.7) +
  facet_wrap(~variant) +
  # geom_text(data = ann_text,label="*") +
  scale_fill_manual(values = c("#DC0000FF", "#3C5488FF", "#00A087FF", "gray")) +
  scale_color_manual(values = c("#DC0000FF", "#3C5488FF", "#00A087FF", "gray")) +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        panel.border = element_rect(color = "gray", fill = NA, size = 0.7),
        axis.text.x = element_text(size = 12, color = "black", angle = 0, margin = margin(t = 2)),
        axis.text.y = element_text(size = 12, colour = "black"),
        axis.title.y = element_text(size = 14),
        axis.ticks.length = unit(0.1, "cm"),
        legend.position = "top",
        legend.direction = "horizontal",
        strip.background = element_rect(color = "gray")) +
  geom_text(aes(label = significant, x = upper + 0.5)) +
  labs(x = "", y = "") +
  guides(color = guide_legend(title = NULL), fill = guide_legend(title = NULL))

# 保存图形
# Save plot
ggsave(filename = "Error_bar_plot02.pdf", plot = p3, width = 10, height = 7, useDingbats = FALSE, limitsize = FALSE)

```

![](Error_bar_plot02.jpg)

