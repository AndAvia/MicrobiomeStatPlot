---
title: "Kernal Density Plot"
author: "Defeng Bai Agricultural Genomics Institute at Shenzhen, Chinese Academy of Agricultural Sciences"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo=T, comment=NA, message=F, warning=F,
	fig.align="center", fig.width=5, fig.height=3, dpi=300)
```


## 核密度估计图
Kernal density plot

什么是核密度估计图？
What is kernal density plot?

参考：https://mp.weixin.qq.com/s/y-aE0RdJULRrgLYdvA6oYQ

核密度估计图（kernal density plot）用于显示数据在X轴连续数据段内的分布情况。这种图表是直方图的变种，使用平滑曲线来绘制水平数值，从而得出更平滑的分布。核密度估计图比直方图优胜的地方在于它们不受所使用分组数量的影响，所以能更好地界定分布形状。

Kernel density plots are used to show the distribution of data in continuous data segments on the X-axis. This type of chart is a variation of the histogram, using smooth curves to plot horizontal values, resulting in a smoother distribution. Kernel density plots are superior to histograms in that they are not affected by the number of groups used, so they can better define the shape of the distribution.


## 核密度估计图案例
Kernak density plot example

这是来自于哈佛大学医学院Dong D. Wang团队2024年发表于Nature Medicine上的一篇论文用到的核密度图展示样本年龄的分布情况。论文题目为：Strain-specific gut microbial signatures in type 2 diabetes identified in a cross-cohort analysis of 8,117 metagenomes

This is a kernel density map used in a paper published in Nature Medicine in 2024 by Dong D. Wang's team from Harvard Medical School to show the distribution of sample age. The title of the paper is: Strain-specific gut microbial signatures in type 2 diabetes identified in a cross-cohort analysis of 8,117 metagenomes

![](e1.kernal.density01.jpg)


## 核密度图R语言实战
Kernal density plot usinng R software

```{r kernal density}
#install.packages("ggridges")
# 读取CSV文件(read csv file)
data <- read.csv("data01.csv", header = TRUE, sep = ",")

# 创建颜色映射(creat color)
studycol <- c("#466983", "#339900", "#837B8D", 
              "#809900", "#5DB1DD", "#802268",
              "#CC9900", "#CE3D32","#C75127", "#996600")
study_names <- c("DIRECT-PLUS (ISR)", "Fromentin_2022 (DEU/DNK/FRA)", "HPFS (USA)", 
                 "Karlsson_2013 (SWE)", "NHSII (USA)", "Qin_2012 (CHN)",
                 "SOL (USA)", "Wu_2020a (SWE)", "Wu_2020b (SWE)", "Zhong_2019 (CHN)")
names(studycol) <- study_names

# 将Study列转换为因子，并指定顺序
# Convert the Study column to a factor and specify the order
data$study <- factor(data$study, levels = study_names)

# 按照指定顺序排列数据
# Sort the data in the specified order
#data <- data[order(data$study, decreasing = FALSE), ]

# 加载所需的包(load packages)
library(ggplot2)
library(ggridges)

# 创建图形，按照指定顺序绘制
# Create graphics and draw them in the specified order
ggplot(data, aes(x = age, y = study, fill = study)) +
  geom_density_ridges(order = order(data$study, decreasing = FALSE)) +
  scale_fill_manual(values = studycol) +
  theme_minimal()

# 读取CSV文件(read csv file)
data <- read.csv("data01.csv", header = TRUE, sep = ",")

# 创建颜色映射(creat color)
studycol <- c("#466983", "#339900", "#837B8D", 
              "#809900", "#5DB1DD", "#802268",
              "#CC9900", "#CE3D32","#C75127", "#996600")
study_names <- c("DIRECT-PLUS (ISR)", "Fromentin_2022 (DEU/DNK/FRA)", "HPFS (USA)", 
                 "Karlsson_2013 (SWE)", "NHSII (USA)", "Qin_2012 (CHN)",
                 "SOL (USA)", "Wu_2020a (SWE)", "Wu_2020b (SWE)", "Zhong_2019 (CHN)")
names(studycol) <- study_names

# 将Study列转换为因子，并指定顺序
# Create graphics and draw them in the specified order
data$study <- factor(data$study, levels = rev(study_names))  # 将顺序反转(Reverse the order)

# 创建图形，按照指定顺序绘制
# Create graphics and draw them in the specified order
p1 <- ggplot(data, aes(x = age, y = study, fill = study)) +
  geom_density_ridges() +
  scale_fill_manual(values = studycol, guide = guide_legend(reverse = TRUE)) +
  theme_bw()+
  scale_x_continuous(breaks = seq(0,100, by=20))+
  labs(x="Age (years)", y="Density")+
  theme(legend.position = "bottom",
        panel.grid = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        element_text(family = "sans"))+
  guides(fill = guide_legend(nrow = 3, byrow = TRUE, reverse = TRUE))  # 将图例分成三行显示

p1

ggsave(paste("density01",".pdf", sep=""), p1, width=55 * 1.5, height=70 * 1.5, unit='mm')

```

