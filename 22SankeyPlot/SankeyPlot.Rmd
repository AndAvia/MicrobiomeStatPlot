---
title: "Sankey Plot"
author: "Defeng Bai Agricultural Genomics Institute at Shenzhen, Chinese Academy of Agricultural Sciences"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo=T, comment=NA, message=F, warning=F,
	fig.align="center", fig.width=5, fig.height=3, dpi=300)
```


### 桑基图在微生物研究中的应用
The application of Sankey plot in microbial research

桑基图又称桑基能量分流图或桑基能量平衡图，是一种特定类型的流程图，是一种表现数据间包含和权重关系流向的统计图标，常见的布局形式有左右流向布局和上下流向布局，其中线条的粗细代表了数值的大小，线条的颜色代表不同的分支种类，通过线条流动的位置和归属，来表现各类别数据之间的包含关系。
The Sankey plot, also known as the Sankey energy diversion diagram or Sankey energy balance diagram, is a specific type of flowchart that represents the flow direction of data inclusion and weight relationships. Common layout forms include left and right flow layout and up and down flow layout, where the thickness of the lines represents the size of the values, and the color of the lines represents different types of branches. The inclusion relationship between different categories of data is represented by the position and attribution of the line flow.
桑基图的起始流量和结束流量相同，所有主支宽度的总和与所有分出去的分支宽度总和相等，保持能量的平衡；各主支和分支不同的宽度代表了不同的流量大小；不同宽度的线条代表了不同的流量分流情况，线条的宽度成比例地显示此分支占有地流量。
The starting and ending flow rates of the Sankey diagram are the same, and the sum of the widths of all main branches is equal to the sum of the widths of all branching branches, maintaining energy balance; The different widths of each main branch and branch represent different flow sizes; The lines with different widths represent different flow diversion situations, and the width of the lines proportionally displays the flow occupied by this branch.
桑基图用于描述一组数值转化成另一组数值的流向，观察数据的流转情况。
The Sankey plot is used to describe the flow direction of converting one set of numerical values into another, and to observe the flow of data


### 桑基图案例
Case study of Sankey plot

##### 例1：桑基图展示功能通路和KO基因差异
Example 1: Sangi diagram showing differences in functional pathways and KO genes

本文是上海交通大学Chen Haoyan课题组于2023年发表于Cell Host & Microbe上的一篇文章用到的桑基图和气泡图结合，展示KEGG功能通路和KO基因差异。题目为：Multi-kingdom gut microbiota analyses define bacterial-fungal interplay and microbial markers of pan-cancer immunotherapy across cohorts。

This article is an article published by Chen Haoyan's research group at Shanghai Jiao Tong University in 2023 on Cell Host&Microbe, which combines the Sangi plot and bubble plot to demonstrate the differences in KEGG functional pathways and KO genes. The title is: Multi kingdom gut microbiota analyses define bacterial empty interplay and microbial markers of pan cancer immune across cohorts.

![](e1.Cell.Host.Microbe2023.jpg)

Figure 6 (A) (Left) Sankey plot showing the distribution of Kyoto Encyclopedia of Genes and Genomes (KEGG) levels and differential KO genes involving in metabolism. (Right) Bubble plot showing the generalized fold change of KO genes. Color of the dot represents log10(FDR).
图 6 (A) （左）Sankey 图显示京都基因组百科全书（KEGG）水平的分布和涉及新陈代谢的不同 KO 基因。(右图）气泡图显示 KO 基因的广义折叠变化。点的颜色代表 log10(FDR)。

**结果**：
The intestinal microbiota can regulate host physiology and maintenance. Since the gut microbiome differed between responders and non-responders, we hypothesized that microbial functions exhibited distinct patterns in the two response phenotypes. To test this, we investigated functional alterations in Kyoto Encyclopedia of Genes and Genomes (KEGG) orthology (KO) genes, pathways, and EggNOG orthology genes in 4 datasets treated with anti-PD-1 monotherapy. The most significantly enriched metabolic KO gene in responders was involved in purine metabolism, followed by a gene involved in butanoate metabolism (Figure 6A). K00700 (EC:2.4.1.18) was involved in starch and sucrose metabolism (Figure 6A), directly responsible for the synthesis of starch from amylose.
肠道微生物群可以调节宿主的生理机能和维持宿主的健康。由于应答者和非应答者的肠道微生物组不同，我们假设微生物功能在两种应答表型中表现出不同的模式。为了验证这一假设，我们研究了接受抗PD-1单药治疗的4个数据集中的《京都基因组百科全书》（KEGG）正选（KO）基因、通路和EggNOG正选基因的功能变化。应答者中最明显富集的代谢 KO 基因参与了嘌呤代谢，其次是一个参与丁酸代谢的基因（图 6A）。K00700（EC:2.4.1.18）参与淀粉和蔗糖代谢（图 6A），直接负责从淀粉中合成淀粉。


### 桑基图实现
Sankey plot implementation

```{r snakey plots, echo=TRUE}
# 安装并加载所需的R包
# Install and load the required R packages
# install.packages("remotes")
# remotes::install_github("davidsjoberg/ggsankey")
library(ggsankey)
library(ggalluvial)
library(ggplot2)

# 读取数据
# Read data
df01 <- read.table(file = "data_sankey3.txt", sep = "\t", header = TRUE, check.names = FALSE)
data <- df01

# 将数据转换为lodes形式
# Convert data to lodes form
df <- to_lodes_form(data[, 1:ncol(data)],
                    axes = 1:ncol(data),
                    id = "value")

# 绘制桑基图（Sankey diagram）
# Draw Sankey diagram
col <- rep(c('#0ca9ce', '#78cfe5', '#c6ecf1', '#ff6f81', '#ff9c8f', '#ffc2c0', '#d386bf',
             '#cdb1d2', '#fae6f0', '#eb6fa6', '#ff88b5', '#00b1a5', "#ffa68f", "#ffca75", "#97bc83", "#acd295",
             "#00ada1", "#009f93", "#ace2da", "#448c99", "#00b3bc", "#b8d8c9", "#db888e", "#e397a4", "#ead0c7",
             "#8f9898", "#bfcfcb"), 6)

p1 <- ggplot(df, aes(x = x, fill = stratum, label = stratum,
                     stratum = stratum, alluvium = value), width = 0.1) +
  geom_flow(width = 0.1,
            curve_type = "sine",
            alpha = 0.6,
            color = 'white',
            size = 0.05) +
  geom_stratum(width = 0.1, color = "white") +
  geom_text(stat = 'stratum', size = 2.5, color = 'black') +
  scale_fill_manual(values = col) +
  theme_void() +
  theme(legend.position = 'none')

# 保存绘图结果
# Save the plot
ggsave(filename = "Figure_sankey01.pdf", plot = p1, width = 7, height = 5, useDingbats = FALSE, limitsize = FALSE)

# 显示绘图结果
# Display the plot
p1

```
