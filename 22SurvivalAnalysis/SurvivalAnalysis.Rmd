---
title: "Survival Analysis"
author: "Defeng Bai Agricultural Genomics Institute at Shenzhen, Chinese Academy of Agricultural Sciences"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo=T, comment=NA, message=F, warning=F,
	fig.align="center", fig.width=5, fig.height=3, dpi=300)
```

## 生存分析（Survival analysis）

什么是生存分析？
What is survival analysis?
参考：https://mp.weixin.qq.com/s/9ZtE2erTvjvMX6s6Ppx2nw

生存分析（survival analysis）主要用来处理考虑发生时间的二分类结局变量，不仅考虑事件是否出现，而且考虑事件出现的事件长短，因此这类方法也称为事件事件分析（time-to-event analysis）。生存分析的资料常常分为终点事件（如死亡）和删失（其他生存结局）两类，其特点包括：1.同时考虑两个变量，生存时间和生存结局；2.通常含有删失数据；3.生存时间的分布通常不服从正态分布。
Survival analysis is mainly used to handle binary outcome variables that consider the time of occurrence. It not only considers whether the event occurred, but also the length of the event that occurred. Therefore, this type of method is also known as time to event analysis. The data for survival analysis is often divided into two categories: endpoint events (such as death) and deletion (other survival outcomes), which have the characteristics of: 1. simultaneously considering two variables, survival time and survival outcome; 2. Usually containing deleted data; The distribution of survival time usually does not conform to a normal distribution.

什么是删失数据？
What is missing data deletion?
再研究结束的时候，研究对象发生了研究之外的其他事件或生存结局，无法明确从开始观察到发生终点事件的生存事件，我们把这种类型的数据称之为删失数据。
At the end of the study, if the research subject experiences other events or survival outcomes outside of the study, it is unclear which survival events occurred from the beginning to the endpoint. We refer to this type of data as censored data.

生存期的几个概念
Several Concepts of Survival
总体生存期（overall survival, OS）
任何原因导致的死亡，只关心是否死亡，不关心因为何种原因死亡。
Death caused by any reason, only concerned about whether or not to die, not about the reason for death.

疾病特异性生存期（disease specific survival, DSS）
结局指标为由特定疾病导致的死亡，反映特定疾病的临床获益。但患者的死因经常并不容易明确。
The outcome measure is death caused by a specific disease, reflecting the clinical benefits of the specific disease. But the cause of death for patients is often not easy to determine.

无进展生存期（progression free survival, PFS）
疾病经过治疗后没有出现进一步恶化的生存期，结局指标是发生恶化或死亡，要求对发生恶化的标准进行明确的定义。
After treatment, there is no further deterioration in the survival period of the disease, and the outcome indicator is the occurrence of deterioration or death, requiring a clear definition of the criteria for occurrence of deterioration.

无病生存期（disease free survival, DFS）
从随机化开始至疾病复发或由于疾病进展导致患者死亡的事件，不关心因为何种原因死亡。要求对发生复发的标准进行明确的定义。
Events that occur from randomization to disease recurrence or death due to disease progression, regardless of the cause of death. Clear definition of criteria for recurrence is required.

生存分析的主要方法：
The main methods of survival analysis
1.非参数法：Log rank检验等
1. Non parametric method: Log rank test, etc
一般肿瘤治疗药物临床试验会采样Log rank检验法。Log-rank检验对晚期死亡事件权重较大，对数据分布的要求较低，主要用于比较两组生存曲线是否存在差异，回答“是否有效”的问题，但无法衡量效果大小，P值作为验证主要结局是否阳性的证据。
Generally, clinical trials of tumor treatment drugs use the Log rank test method for sampling. The Log rank test has a higher weight for late death events and lower requirements for data distribution. It is mainly used to compare whether there is a difference in survival curves between two groups and answer the question of "whether it is effective", but cannot measure the size of the effect. The P-value serves as evidence to verify whether the main outcome is positive.

2.半参数法：Cox回归分析
2. Semi parametric method: Cox regression analysis
考虑随访事件，用Cox回归获得HR，更直观的测量治疗效果。
Consider follow-up events and use Cox regression to obtain HR for a more intuitive measurement of treatment effectiveness.

3.Kaplan-Meier法
3. Kaplan-Meier method
Kaplan-Meier法估计的生存率是一个累积的生存率，或者说是一个条件的生存率，前面的条件再乘以当前的生存率，通常用生存曲线描述生存过程。
The survival rate estimated by Kaplan Meier method is a cumulative survival rate, or rather a conditional survival rate. The previous conditions are multiplied by the current survival rate, and the survival process is usually described using a survival curve.

不同的生存分析内容，选择不同分分析策略
Different survival analysis contents, selecting different sub analysis strategies
-计算生存率，中位生存事件，用生存曲线描述生存过程：Kaplan-Meier方法
-Calculate survival rate, median survival event, and describe survival process using survival curve: Kaplan Meier method
-生存时间分布的时间比较：log Rank
-Time comparison of survival time distribution: log Rank
-探讨生存时间（生存速度）的影响因素：Cox回归分析
-Exploring the influencing factors of survival time (survival rate): Cox regression analysis


## 生存分析案例
Survival analysis case

这是Jakob Stokholm课题组2023年发表于Nature Medicine上的文章，第一作者为Cristina Leal Rodríguez，题目为：The infant gut virome is associated with preschool asthma risk independently of bacteria

This is an article published by the Jakob Stokholm research group in Nature Medicine in 2023. The first author is Cristina Leal Rodr í guez, and the title is: The incident gut virus is associated with pre-school astroma risk independently of bacteria

![](01.SurvivalAnalysis.01.png)

Fig. 5 d, Kaplan–Meier curves displaying the cumulative incidence of asthma to 5 years of age. Children’s asthma signature scores were divided into high (above median) and low (below median) for both the bacteriome and virome, resulting in four combined groups (low–low, low–high, high–low and high–high). The P value for the difference in groups was determined by the two-sided log-rank test. 

图5 d、 Kaplan-Meier曲线显示5岁哮喘的累计发病率。儿童哮喘特征评分分为细菌组和病毒组的高（高于中位数）和低（低于中位数），分为四组（低-低、低-高、高-低和高-高）。组间差异的P值通过双侧对数秩检验确定。

**结果**：
Finally, we estimated the cumulative incidence of asthma in four different groups of children based on their combined virome and bacteriome signature scores (low–low, low–high, high–low and high–high) and found a difference in the time to asthma diagnosis (two-sided log-rank test, P = 0.004, Fig. 5d). These four groups were also different in a Cox survival model (overall P = 0.005, low–low as reference; low–high hazard ratio (HR) = 1.53 (0.86–2.70); P = 0.147; high–low HR = 1.46 (0.82–2.61); P = 0.188; high–high HR = 2.39 (1.46–3.93); P = 5.94 × 10−4). Furthermore, to assess the cumulative and combined effect of virome and bacteriome, we computed a combined score (low–low = 1; low–high or high-low = 2; high–high = 3), which showed complementarity between the virome and bacteriome, indicating a 53% increase per group in the likelihood that the children receive an asthma diagnosis (HR = 1.53 (1.21–1.95); P = 4.08 × 10−4). 

最后，我们根据四组不同儿童的病毒组和细菌组特征评分（低-低、低-高、高-低和高-高）估计了他们的哮喘累积发病率，并发现哮喘诊断时间存在差异（双侧对数秩检验，P=0.004，图5d）。这四组在Cox生存模型中也有所不同（总体P=0.005，低-低作为参考；低-高风险比（HR）=1.53（0.86–2.70）；P=0.147；高-低HR=1.46（0.82–2.61）；P＝0.188；高-高HR=2.39（1.46–3.93）；P＝5.94×10−4）。此外，为了评估病毒组和细菌组的累积和综合效应，我们计算了一个综合评分（低-低=1；低-高或高-低=2；高-高=3），该评分显示了病毒组和菌组之间的互补性，表明每组儿童接受哮喘诊断的可能性增加了53%（HR=1.53（1.21-1.95）；P＝4.08×10−4）。


## 生存分析R语言实战
Survival analysis using R software

参考：https://mp.weixin.qq.com/s/6_vOZVLc3_KZPjNfKsygeQ

```{r survival analysis, include=TRUE}
# 加载使用数据集
# Load data
library(survival)
# data(lung) # 加载lung数据集 (Load the lung dataset)
mydata <- na.omit(survival::lung) # 去除缺失值 (Remove missing values)
# View(mydata) # 查看数据集 (View Dataset)
str(mydata)

# 变量因子化
# Variable factorization
mydata[, c("sex", "ph.ecog")] <- lapply(mydata[, c("sex", "ph.ecog")], as.factor)

# 基线特征描述统计
# Baseline feature description statistics
# install.packages("autoReg")
library(autoReg)
library(dplyr)
table1 <- gaze(status ~ ., data = mydata) %>% myft()
table1
table2 <- gaze(status ~ ., data = mydata, method = 3) %>% myft()
table2

# install.packages("rrtable")
library(rrtable)
# table2pptx(ft) # Exported table as Report.pptx
# table2docx(ft) # Exported table as Report.docx

# 拟合生存曲线
# Fit survival curve
# 1. 创建生存对象
# 1. Create a survival object
# 在survival包中先使用Surv()函数创建生存对象，生存对象是将事件、时间和删失信息合并在一起的数据结构。
# In the survival package, first use the Surv() function to create a survival object, which is a data structure that combines event, time, and deletion information.
attach(mydata) # 绑定数据集 (Bind Dataset)
Surv(time, status) # 创建生存对象 (Creating Survival Objects)
# 在下面输出的生存对象中，带"+"号的表示右删失数据
# In the survival objects output below, those with a "+" sign indicate right deletion of missing data

# 2. 拟合曲线 (Fitting curves)
# R中使用survfit()函数来拟合生存曲线。
# Use the survfit() function in R to fit the survival curve.
# 如果要创建一条不考虑任何比较的生存曲线，只需要指定survfit()在公式里期望的截距为~1。这一点与lm()、glm()相似
# If you want to create a survival curve that does not consider any comparisons, simply specify that the expected intercept of survfit() in the formula is ~1. This is similar to lm() and glm()
survfit(Surv(time, status) ~ 1)
fit <- survfit(Surv(time, status) ~ sex, # 创建生存对象 (Creating Survival Objects)
               data = mydata) 
fit
# 从下图可知，lung数据集中男性103例，女性64例；男性和女性发生结局事件分别有82例和38例。男性和女性的中位生存时间分别为284天和426天。
# As shown in the figure below, there are 103 males and 64 females in the lung dataset; there were 82 cases of outcome events in males and 38 cases in females, respectively. The median survival time for males and females is 284 days and 426 days, respectively.

# 还可以使用summary()函数输出更多详细信息。
# You can also use the summary() function to output more detailed information
#summary(fit)
# summary()函数中可以设定时间参数用来选定一个时间区间
# The summary() function can set time parameters to select a time interval
#summary(fit, times = seq(0, 1000, 100))
# 下图中survival为生存函数在生存时间点处的KM估计值。同时，输出结果中还给出了估计的标准误差和95%置信区间。
# The survival in the following figure represents the estimated KM value of the survival function at the survival time point. At the same time, the output results also provide the estimated standard error and 95% confidence interval.

# install.packages("survminer")
library(survminer)
ggsurvplot(fit, 
           data = mydata, 
           conf.int = TRUE, 
           pval = TRUE, 
           surv.median.line = "hv", 
           risk.table = TRUE, 
           xlab = "Follow up time(d)", 
           legend = c(0.8, 0.75),
           legend.title = "", 
           legend.labs = c("Male", "Female"), 
           break.x.by = 100, 
           palette = "nejm")

# log-rank检验 (log-rank test)
# 参考: https://mp.weixin.qq.com/s/bV1fNA_1ZiyK7lE-yfY1Lg
survdiff(Surv(time, status) ~ ph.ecog, mydata)
pairwise_survdiff(Surv(time, status) ~ ph.ecog, mydata, p.adjust.method = "BH")

# cox回归模型 (cox regression)
fit <- coxph(Surv(time, status) ~ age + sex + ph.ecog + ph.karno + pat.karno + meal.cal + wt.loss, 
             data = mydata)
summary(fit)

# cox回归结果快速整理
# Quick organization of Cox regression results
# install.packages("autoReg")
library(autoReg)
autoReg(fit, uni = TRUE, threshold = 0.05)
autoReg(fit)
coxresult <- autoReg(fit, uni = TRUE) %>% myft()
library(rrtable)
table2pptx(coxresult) # Exported table as Report.pptx
table2docx(coxresult) # Exported table as Report.docx

# cox回归模型结果森林图
# Cox regression model results forest map
library(survminer)
ggforest(fit, mydata)
ggforest(fit, mydata,
         main = "Hazard ratio",
         # 前三列的位置，第二列是样品数，设了个负值，相当于隐藏了
         # The position of the first three columns, and the second column is the number of samples. Setting a negative value is equivalent to hiding it
         cpositions = c(0.02, -0.15, 0.25), 
         fontsize = 0.8, # 字体大小
         refLabel = "reference",
         noDigits = 2)

# 续变量截断值
# Continuation variable truncation value
# 参考 https://mp.weixin.qq.com/s/TB43jWO7CX8_o2eUXWl1Fw
# 参考 https://mp.weixin.qq.com/s/o5DyMpvTiN0nl2P-TudCOA
mydata$status <- mydata$status - 1 # 转换成常见的0, 1 (Convert to common 0, 1)
mydata$sex <- ifelse(mydata$sex == 1, "Male", "Female")
library(survminer)
res.cut <- surv_cutpoint(mydata, time = "time", event = "status",
                         variables = c("age", "meal.cal", "ph.karno", "pat.karno")) # 找这3个变量的最佳切点 (Find the best cut point for these three variables)
summary(res.cut)
# 使用surv_categorize()函数根据最佳截断值对数据进行分组（高表达/低表达组）：
# Use the surv_categorize() function to group data based on the best truncation value (high expression/low expression groups):
mydata_cut <- surv_categorize(res.cut)
head(mydata_cut)
mydata <- cbind(mydata[, c("sex", "ph.ecog", "wt.loss")], mydata_cut)
str(mydata)

# 亚组分析
# Subgroup analysis
# 参考: https://mp.weixin.qq.com/s/P_MiO16_mdzFx8ITmnkIpw
# install.packages("jstable")
# From github: latest version
# remotes::install_github('jinseob2kim/jstable')
library(jstable)
res <- TableSubgroupMultiCox(formula = Surv(time, status) ~ sex, # 指定哪些变量有亚组 (Set subgroup)
                             var_subgroups = c("age", "meal.cal", "ph.karno", "pat.karno"), data = mydata) 
res
write.csv(res, "res.csv") # 输出为csv格式 (Output in CSV format)

```

